version: '3.9'
services:

  etcd:
    image: "bitnami/etcd:latest"
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
    ports:
      - 2379:2379
      - 2380:2380

  etcdsetup:
    image: "bitnami/etcd:latest"
    depends_on:
      - etcd
    restart: "no"
    command: etcdctl put --endpoints http://etcd:2379 /this ${DATACLAY_ID:?err}


  metadata-service:
    image: "bscdataclay/pyclay:dev"
    depends_on:
      etcdsetup:
        condition: service_completed_successfully
    ports:
      - "16587:16587"
    environment:
      - ETCD_HOST=etcd
    command: python -m dataclay.metadata
    volumes:
      - ../:/pyclay

  backend:
    image: "bscdataclay/pyclay:dev"
    depends_on:
      etcdsetup:
        condition: service_completed_successfully
    environment:
      - DC_BACKEND_NAME=DS1
      - ETCD_HOST=etcd
      - ETCD_PORT=2379
      - DEBUG=true
    command: python -m dataclay.backend
    volumes:
      - ../:/pyclay
      - ./functional/model:/workdir/model
